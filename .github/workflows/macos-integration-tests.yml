name: macOS Integration Tests

on:
  push:
  pull_request:

jobs:
  test-macos:
    runs-on: macos-14
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install CocoaPods
        run: brew install cocoapods

      - name: Install uv
        shell: bash
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install Flutter via repo scripts
        shell: bash
        run: |
          set -euo pipefail
          source ci/common.sh
          source ci/install_flutter.sh
          flutter --version

      - name: Show tool versions
        run: |
          python3 --version
          uv --version
          pod --version

      - name: Run integration tests
        working-directory: sdk/python
        run: |
          uv run pytest -s -o log_cli=true -o log_cli_level=INFO packages/flet/integration_tests

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-failures-macos
          path: sdk/python/packages/flet/integration_tests/**/*_actual.png
          if-no-files-found: ignore
