name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.head.ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build_and_release: ${{ steps.changed-files.outputs.build_and_release_any_changed }}
      macos_integration_tests: ${{ steps.changed-files.outputs.macos_integration_tests_any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          separator: "\n"
          files_yaml: |
            build_and_release:
              - .fvmrc
              - .github/workflows/ci.yml
              - .github/workflows/build-and-release.yml
              - .github/scripts/**
              - client/**
              - packages/flet/**
              - sdk/python/packages/**
              - sdk/python/pyproject.toml
            macos_integration_tests:
              - .fvmrc
              - .github/workflows/ci.yml
              - .github/workflows/macos-integration-tests.yml
              - client/**
              - packages/flet/**
              - sdk/python/pyproject.toml
              - sdk/python/packages/flet/src/**
              - sdk/python/packages/flet/integration_tests/**
              - sdk/python/packages/flet/pyproject.toml
          files_ignore: |
            sdk/python/packages/flet/docs/**

      - name: List all changed files
        if: steps.changed-files.outputs.build_and_release_any_changed == 'true' || steps.changed-files.outputs.macos_integration_tests_any_changed == 'true'
        env:
          BUILD_CHANGED_FILES: ${{ steps.changed-files.outputs.build_and_release_all_changed_files }}
          MACOS_CHANGED_FILES: ${{ steps.changed-files.outputs.macos_integration_tests_all_changed_files }}
        run: |
          printf '%s\n' "$BUILD_CHANGED_FILES" "$MACOS_CHANGED_FILES" | sed '/^$/d' | sort -u

  build_and_release:
    name: Build & Release
    needs: changes
    if: needs.changes.outputs.build_and_release == 'true' || startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/build-and-release.yml
    permissions:
      id-token: write
      contents: write

  macos_integration_tests:
    name: macOS Integration Tests
    needs: changes
    if: needs.changes.outputs.macos_integration_tests == 'true'
    uses: ./.github/workflows/macos-integration-tests.yml
    permissions:
      contents: read
